name: Build Multi-Platform

on: workflow_dispatch

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - platform: iOS
            project: CBPlatformTest.iOS/CBPlatformTest.iOS.csproj
            output_dir: CBPlatformTest.iOS
            runtime: ios-arm64
            workload: ios
            os: macos-26
            tfm: net9.0-ios
          - platform: DesktopGL
            project: CBPlatformTest.DesktopGL/CBPlatformTest.DesktopGL.csproj
            output_dir: CBPlatformTest.DesktopGL
            runtime: win-x64
            workload: ""
            os: windows-latest
            tfm: net9.0
          - platform: Android
            project: CBPlatformTest.Android/CBPlatformTest.Android.csproj
            output_dir: CBPlatformTest.Android
            runtime: android-arm64
            workload: android
            os: windows-latest
            tfm: net9.0-android
    steps:
      - name: Suppress RID warning
        run: echo "DOTNET_SUPPRESS_RUNTIME_IDENTIFIER_WARNING=1" >> $GITHUB_ENV      

      - uses: actions/checkout@v5

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Install workload
        if: ${{ matrix.workload != '' }}
        run: dotnet workload install ${{ matrix.workload }}

      - name: Process content
        uses: ./.github/actions/build-content
        with:
          content-project-path: "./CBPlatformTest/Content"
          assets-source-path: "./CBPlatformTest/Content/Assets"
          monogame-platform: ${{ matrix.platform }}
          output-folder: "./CBPlatformTest/${{ matrix.output_dir }}/bin/Release/Content"
          runtime-identifier: ${{ matrix.runtime }}

      - name: Restore ${{ matrix.platform }}
        working-directory: ./CBPlatformTest
        run: dotnet restore ${{ matrix.project }} -r ${{ matrix.runtime }}

      - name: Build ${{ matrix.platform }}
        working-directory: ./CBPlatformTest
        run: dotnet build -c Release ${{ matrix.project }}${{ matrix.platform == 'iOS' && '' || format(' -r {0}', matrix.runtime) }} -p:WorkflowMode=true

      - name: Archive ${{ matrix.platform }} build
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path build-artifacts -Force | Out-Null
          Compress-Archive -Path "CBPlatformTest/${{ matrix.output_dir }}/bin/Release/*" -DestinationPath "build-artifacts/CBPlatformTest-${{ matrix.platform }}.zip" -Force

      - name: Upload ${{ matrix.platform }} artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.platform }}-build
          path: build-artifacts/

      - name: Publish ${{ matrix.platform }} release
        working-directory: ./CBPlatformTest
        run: dotnet publish ${{ matrix.project }} -c Release -r ${{ matrix.runtime }} -p:PublishReadyToRun=false -p:TieredCompilation=false --self-contained --no-build

      - name: Archive ${{ matrix.platform }} publish
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path publish-artifacts -Force | Out-Null
          Compress-Archive -Path "CBPlatformTest/${{ matrix.output_dir }}/bin/Release/${{ matrix.tfm }}/${{ matrix.runtime }}/publish/*" -DestinationPath "publish-artifacts/CBPlatformTest-${{ matrix.platform }}-publish.zip" -Force

      - name: Upload ${{ matrix.platform }} publish artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.platform }}-publish
          path: publish-artifacts/
